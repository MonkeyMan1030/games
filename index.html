<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Archive</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ruffle (Flash Emulator) -->
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Retro Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <style>
        body { background-color: #121212; overflow: hidden; }
        
        /* Typography */
        .font-pixel { font-family: 'Press Start 2P', cursive; }
        .font-retro { font-family: 'VT323', monospace; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }

        /* Game Grid Styling */
        .game-card { transition: all 0.2s; }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px #e94560;
            border-color: #e94560;
        }

        /* Heart Animation */
        .heart-btn:active { transform: scale(0.8); }
        .liked { color: #e94560 !important; }

        /* Boss Mode Styles (Fake Word Doc) */
        #boss-interface {
            font-family: Calibri, Arial, sans-serif;
            background: #f3f2f1;
            color: black;
            display: none;
        }
        .boss-active #boss-interface { display: flex; }
        .boss-active #game-interface { display: none; }
        
        .paper-shadow { box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="h-screen w-screen">

    <!-- =========================== -->
    <!-- 1. GAME INTERFACE           -->
    <!-- =========================== -->
    <div id="game-interface" class="h-full w-full flex flex-col bg-gray-900 text-white overflow-y-auto">
        
        <!-- Header -->
        <nav class="bg-gray-800 p-4 border-b-4 border-indigo-600 sticky top-0 z-30 shadow-lg">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <h1 class="font-pixel text-yellow-400 text-sm md:text-lg">
                    <span class="text-indigo-400">GITHUB</span> ARCADE
                </h1>
                
                <!-- SEARCH & SORT TOOLBAR -->
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                    <!-- Search -->
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Search games..." 
                            class="bg-gray-700 text-white pl-10 pr-4 py-2 rounded border border-gray-600 focus:outline-none focus:border-indigo-500 font-retro text-lg w-full">
                    </div>

                    <!-- Sort -->
                    <div class="relative">
                        <select id="sortSelect" class="bg-gray-700 text-white pl-4 pr-8 py-2 rounded border border-gray-600 focus:outline-none focus:border-indigo-500 font-retro text-lg appearance-none w-full cursor-pointer">
                            <option value="popularity">ðŸ”¥ Most Popular</option>
                            <option value="az">A-Z Title</option>
                            <option value="za">Z-A Title</option>
                            <option value="scratch">Type: Scratch</option>
                            <option value="flash">Type: Flash</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <div class="font-retro text-xl text-gray-400 hidden lg:block">
                    BOSS MODE: <span class="text-white border border-gray-500 px-2 rounded">ESC</span>
                </div>
            </div>
        </nav>

        <!-- Dynamic Game Grid -->
        <main class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
            <!-- Stats Bar -->
            <div class="flex justify-between items-end mb-6 border-b border-gray-700 pb-2">
                <span id="gameCount" class="font-retro text-xl text-gray-400">Connecting to Database...</span>
                <span class="text-xs text-gray-500 font-mono">v2.1.0</span>
            </div>

            <div id="game-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Javascript will inject games here -->
                <div class="col-span-full text-center py-20 text-gray-500 font-pixel text-xs animate-pulse">
                    LOADING CARTRIDGES...
                </div>
            </div>
            
            <div id="no-results" class="hidden col-span-full text-center py-20">
                <p class="font-pixel text-red-400 mb-2">NO GAMES FOUND</p>
                <button onclick="resetSearch()" class="text-indigo-400 underline font-retro text-xl">Clear Search</button>
            </div>
        </main>
    </div>

    <!-- =========================== -->
    <!-- 2. PLAYING MODAL (Overlay)  -->
    <!-- =========================== -->
    <div id="play-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-full max-w-5xl flex justify-between items-center px-4 mb-2">
            <h2 id="modal-title" class="text-white font-retro text-2xl">Game Title</h2>
            <button onclick="closeGame()" class="text-white font-pixel text-xs border border-red-500 hover:bg-red-600 px-4 py-2 rounded transition">
                CLOSE [X]
            </button>
        </div>
        
        <!-- Game Container -->
        <div id="player-container" class="w-full max-w-5xl h-[80vh] bg-black border-2 border-gray-700 shadow-2xl flex items-center justify-center overflow-hidden relative">
            <!-- Game loads here -->
        </div>
        <p class="text-gray-500 mt-2 font-mono text-xs">Press ESC to close game instantly.</p>
    </div>

    <!-- =========================== -->
    <!-- 3. BOSS MODE (Word Lookalike) -->
    <!-- =========================== -->
    <div id="boss-interface" class="h-full w-full flex-col absolute top-0 left-0 z-[100]">
        <!-- Blue Top Bar -->
        <div class="bg-[#2b579a] text-white px-4 py-2 text-sm flex justify-between items-center">
            <div class="flex gap-4 items-center">
                <span>ðŸ’¾</span>
                <span>Q3_Financial_Projections_Draft_v4.docx</span>
            </div>
            <div class="flex gap-4">
                <span>John Doe</span>
                <span>â”€ â–¡ âœ•</span>
            </div>
        </div>
        <!-- Ribbon -->
        <div class="bg-white border-b border-gray-300 h-24 flex items-center px-4 gap-4 text-xs text-center text-gray-600">
            <div class="flex flex-col gap-1"><span class="text-2xl">ðŸ“‹</span>Paste</div>
            <div class="h-full w-px bg-gray-300 mx-2"></div>
            <div class="flex flex-col items-start gap-1">
                <div class="flex gap-1 border p-0.5"><span class="w-32 text-left">Calibri</span></div>
                <div class="flex gap-1 font-bold"><span class="bg-gray-200 px-2">B</span><span class="px-2">I</span><span class="px-2">U</span></div>
            </div>
        </div>
        <!-- Document Canvas -->
        <div class="flex-1 bg-[#e3e3e3] overflow-y-auto p-8 flex justify-center">
            <div class="bg-white w-[816px] min-h-[1100px] p-[96px] paper-shadow text-black">
                <h1 class="text-3xl text-[#2f5496] mb-4">Quarterly Efficiency Analysis</h1>
                <p class="mb-4"><strong>Date:</strong> October 24, 2024</p>
                <p class="mb-4"><strong>To:</strong> Senior Management</p>
                <p class="mb-8"><strong>Subject:</strong> Optimization of Workflow Processes</p>
                
                <p class="mb-4 text-justify leading-7">
                    The current fiscal quarter has demonstrated a significant variance in projected versus actual output. 
                    Preliminary data suggests that the integration of the new logistical framework has yielded a net positive 
                    ROI of 4.2%, although friction points remain in the supply chain vertical.
                </p>
            </div>
        </div>
    </div>

    <!-- =========================== -->
    <!-- 4. FIREBASE LOGIC           -->
    <!-- =========================== -->
    <script type="module">
        // 1. Import Firebase from CDN (Web-ready URLs)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // 2. YOUR CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCeubvLZk3GDrVPJ-azhrFbgtGl_O6WC4g",
            authDomain: "arcadearchive-d8ae7.firebaseapp.com",
            projectId: "arcadearchive-d8ae7",
            storageBucket: "arcadearchive-d8ae7.firebasestorage.app",
            messagingSenderId: "85038885574",
            appId: "1:85038885574:web:6bcea6438a9da7c12fc5c7"
        };

        // 3. Initialize
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let allGames = [];
        let filteredGames = [];

        // Backup data (for when games.json isn't found in preview)
        const backupGames = [
            { "title": "Appel", "type": "scratch", "id": "60917032", "description": "Classic platformer by Griffpatch." },
            { "title": "Fancy Pants Adv.", "type": "flash", "file": "fancy_pants.swf", "description": "Run fast, wear fancy pants." }
        ];

        // --- LOAD GAMES & SYNC RATINGS ---
        window.loadGames = async function() {
            try {
                // A. Fetch the JSON list
                let gameList = [];
                try {
                    const response = await fetch('games.json');
                    if (!response.ok) throw new Error("File not found");
                    gameList = await response.json();
                } catch (error) {
                    console.warn("Using backup data");
                    gameList = backupGames;
                }

                const userLikes = JSON.parse(localStorage.getItem('arcadeLikes')) || {};

                // B. Fetch LIVE ratings from Firestore
                // We map over games and check the DB for each one
                const mergedGames = await Promise.all(gameList.map(async (game) => {
                    // Create safe ID (Firebase doesn't like . or / in ID names)
                    const uniqueId = (game.id || game.file).toString().replace(/[.#$\[\]]/g, "_");
                    
                    game.uniqueId = uniqueId;
                    game.isLiked = userLikes[uniqueId] ? true : false;
                    
                    // Fetch real count
                    try {
                        const docRef = doc(db, "game_ratings", uniqueId);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            game.likes = docSnap.data().count;
                        } else {
                            // If it's a new game, give it a random starting number or 0
                            game.likes = 0; 
                        }
                    } catch (e) {
                        console.error("DB Error on game:", uniqueId, e);
                        game.likes = 0;
                    }
                    
                    return game;
                }));

                allGames = mergedGames;
                applyFilters();

                // Listeners
                document.getElementById('searchInput').addEventListener('input', applyFilters);
                document.getElementById('sortSelect').addEventListener('change', applyFilters);

            } catch (error) {
                console.error("Critical Load Error:", error);
            }
        }

        // --- FILTER & SORT ---
        window.applyFilters = function() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const sortType = document.getElementById('sortSelect').value;

            filteredGames = allGames.filter(game => {
                return game.title.toLowerCase().includes(query) || 
                       (game.description && game.description.toLowerCase().includes(query));
            });

            if (sortType === 'az') filteredGames.sort((a, b) => a.title.localeCompare(b.title));
            else if (sortType === 'za') filteredGames.sort((a, b) => b.title.localeCompare(a.title));
            else if (sortType === 'popularity') filteredGames.sort((a, b) => b.likes - a.likes);
            else if (sortType === 'scratch') filteredGames = filteredGames.filter(g => g.type === 'scratch');
            else if (sortType === 'flash') filteredGames = filteredGames.filter(g => g.type === 'flash');

            renderGames();
        }

        window.renderGames = function() {
            const container = document.getElementById('game-container');
            const noResults = document.getElementById('no-results');
            const countDisplay = document.getElementById('gameCount');
            
            container.innerHTML = '';
            countDisplay.innerText = `${filteredGames.length} GAMES LOADED`;
            
            if (filteredGames.length === 0) noResults.classList.remove('hidden');
            else noResults.classList.add('hidden');

            filteredGames.forEach(game => {
                const card = document.createElement('div');
                card.className = "game-card bg-gray-800 border-2 border-gray-700 rounded-lg overflow-hidden flex flex-col relative group";
                
                const thumb = game.thumbnail || `https://placehold.co/400x300/2a2a2a/FFF?text=${game.title.charAt(0)}`;

                card.innerHTML = `
                    <div class="h-40 bg-gray-900 overflow-hidden relative cursor-pointer" onclick="launchGame('${game.uniqueId}')">
                        <img src="${thumb}" alt="${game.title}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                        <span class="absolute top-2 right-2 px-2 py-1 text-[10px] font-pixel text-black font-bold z-10 
                            ${game.type === 'flash' ? 'bg-orange-400' : 'bg-blue-400'}">
                            ${game.type.toUpperCase()}
                        </span>
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="fas fa-play text-white text-3xl drop-shadow-lg"></i>
                        </div>
                    </div>
                    
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <h3 class="text-white font-bold font-retro text-xl tracking-wide mb-1 leading-none">${game.title}</h3>
                            <p class="text-gray-400 text-xs truncate mb-3">${game.description || 'Classic Arcade Game'}</p>
                        </div>
                        
                        <div class="flex justify-between items-center border-t border-gray-700 pt-2">
                            <span class="text-xs text-gray-500 font-mono">ID: ${game.uniqueId.substring(0,6)}</span>
                            
                            <button onclick="toggleLike('${game.uniqueId}')" class="heart-btn flex items-center gap-1 text-gray-400 hover:text-white transition ${game.isLiked ? 'liked' : ''}">
                                <i class="${game.isLiked ? 'fas' : 'far'} fa-heart"></i>
                                <span class="font-retro text-lg">${formatNumber(game.likes)}</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- DATABASE UPDATES ---
        window.toggleLike = async function(uniqueId) {
            const game = allGames.find(g => g.uniqueId == uniqueId);
            if (!game) return;

            // 1. Optimistic Update (Instant feedback)
            game.isLiked = !game.isLiked;
            game.likes += game.isLiked ? 1 : -1;
            applyFilters(); // Re-render

            // 2. Local Storage
            const userLikes = JSON.parse(localStorage.getItem('arcadeLikes')) || {};
            if (game.isLiked) userLikes[uniqueId] = true;
            else delete userLikes[uniqueId];
            localStorage.setItem('arcadeLikes', JSON.stringify(userLikes));

            // 3. Firebase Update
            try {
                const docRef = doc(db, "game_ratings", uniqueId);
                // Use 'increment' for atomic updates (prevents race conditions)
                await setDoc(docRef, { 
                    count: increment(game.isLiked ? 1 : -1) 
                }, { merge: true });
            } catch (e) {
                console.error("Firebase Update Failed:", e);
                // In a real app, you might rollback the UI here
            }
        }

        function formatNumber(num) {
            if(!num) return 0;
            return num >= 1000 ? (num/1000).toFixed(1) + 'k' : num;
        }

        // --- UTILS & GAME LAUNCHER ---
        window.resetSearch = function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'popularity';
            applyFilters();
        }

        window.launchGame = function(uniqueId) {
            const game = allGames.find(g => g.uniqueId == uniqueId);
            if (!game) return;

            const modal = document.getElementById('play-modal');
            const container = document.getElementById('player-container');
            document.getElementById('modal-title').innerText = game.title;
            
            container.innerHTML = ''; 
            modal.classList.remove('hidden');

            if (game.type === 'scratch') {
                container.innerHTML = `
                    <iframe src="https://scratch.mit.edu/projects/${game.id}/embed" 
                    allowtransparency="true" width="100%" height="100%" 
                    frameborder="0" scrolling="no" allowfullscreen></iframe>
                `;
            } else if (game.type === 'flash') {
                const player = document.createElement("ruffle-player");
                player.style.width = "100%";
                player.style.height = "100%";
                container.appendChild(player);
                player.load({ url: "swf/" + game.file, backgroundColor: "#000000" });
            }
        }

        window.closeGame = function() {
            document.getElementById('play-modal').classList.add('hidden');
            document.getElementById('player-container').innerHTML = '';
        }

        // Boss Mode Key Listener
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                const modal = document.getElementById('play-modal');
                if (!modal.classList.contains('hidden')) {
                    closeGame();
                } else {
                    document.body.classList.toggle('boss-active');
                    document.title = document.body.classList.contains('boss-active') 
                        ? "Q3_Financial_Projections.docx - Word" 
                        : "Arcade Archive";
                }
            }
        });

        // Initialize
        loadGames();

    </script>
</body>
</html>
